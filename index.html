<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Bluetooth test</title>
	</head>

	<body>
		<h1>ESP32 BLE test web bluetooth API example</h1>
		<button>CONNECT</button>
		<button onclick="onClickTime()">Set Time</button>
		<h1></h1>
		<div id="logs">Log output:</div>
	</body>
</html>
<script>
	// incoming = FROM javascript
	var CHAR_INCOMING = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
	var CHAR_OUTGOING = "7b286112-7eba-4c1d-bcbd-aa1c6439315b";

	var mIn;
	var mOut;

	function log(msg) {
		document.querySelector("#logs").innerHTML =
			document.querySelector("#logs").innerHTML + "<br>" + msg;
	}

	function onCharChange(event) {
		log("onCharChange");
		const value = event.target.value.getUint8();
		console.log("Received " + value);

		log("received: " + value);
	}

	function str2ab(str) {
		var buf = new ArrayBuffer(str.length);
		var bufView = new Uint8Array(buf);
		for (var i = 0, strLen = str.length; i < strLen; i++) {
			bufView[i] = str.charCodeAt(i);
		}

		return buf;
	}

	async function onClickTime() {
		console.log("onClickTime");
		if (mOut != null) {
			var message = {
				command: "set_time",
				time: new Date().getTime(),
			};

			var text = JSON.stringify(message);

			console.log("sending: " + text);

			var buf = str2ab(text);

			await mOut.writeValueWithResponse(buf);
		}
	}

	document
		.querySelector("button")
		.addEventListener("click", async (event) => {
			var options = {
				filters: [
					{ services: ["4fafc201-1fb5-459e-8fcc-c5c9c331914b"] },
					{ name: "M8 Ball" },
				],
			};

			options = {
				acceptAllDevices: true,
				optionalServices: ["4fafc201-1fb5-459e-8fcc-c5c9c331914b"],
			};

			console.log(options);

			navigator.bluetooth
				.requestDevice(options)
				//({
				//acceptAllDevices: true,
				//Services: ["4fafc201-1fb5-459e-8fcc-c5c9c331914b"],
				//})
				.then((device) => 
				{
					log("connecting to " + device.name);
					return device.gatt.connect();
				})
				.then((server) => 
				{
					return server.getPrimaryService(
						"4fafc201-1fb5-459e-8fcc-c5c9c331914b"
					);
					// https://googlechrome.github.io/samples/web-bluetooth/get-characteristics.html?service=4fafc201-1fb5-459e-8fcc-c5c9c331914b
				})
				.then((service) => 
				{
					log("Getting Characteristics...");
					//if (characteristicUuid) {
					//	return service.getCharacteristics(characteristicUuid);
					//}
					// Get all characteristics.
					return service.getCharacteristics();
				})
				.then((characteristics) => 
				{
					log(
						"> Characteristics: " +
							characteristics
								.map((c) => c.uuid)
								.join("\n" + " ".repeat(19))
					);
				})

				/*
				.then((service) => { return service.getCharacteristic(CHAR_INCOMING); })
				.then((characteristic) => characteristic.startNotifications())
				.then((characteristic) => 
                {
					mIn = characteristic;
					characteristic.addEventListener("characteristicvaluechanged", onCharChange);
				})
				.then((service) => { return service.getCharacteristic(CHAR_OUTGOING); })
				.then((characteristic) => characteristic.startNotifications())
				.then((characteristic) => 
                {
					mOut = characteristic;
					characteristic.addEventListener("characteristicvaluechanged", onCharChange);
				})
				.then((characteristic) =>
				{
					log("done!");
				})
*/

				//				.then((characteristic) =>
				//				{
				//					return characteristic.readValue();
				//				})
				//				.then((value) =>
				//				{
				//					log(`Value is ${value.getUint8(0)}`);
				//				})
				.catch((error) => {
					console.log(error);
					log(error.name + ": " + error.message);
				});
		});
</script>
