<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Bluetooth test</title>

		<link href = "https://code.jquery.com/ui/1.10.4/themes/ui-lightness/jquery-ui.css" rel = "stylesheet">
		<script src = "https://code.jquery.com/jquery-3.6.0.js"></script>
		<script src = "https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>
	</head>

	<body>
		<h1>test ESP32 BLE web bluetooth API example</h1>
		<button>CONNECT</button>
		<button onclick="onClickTime()">Set Time</button>
		<h1></h1>
		<div>
			Log output:
			<textarea id="log" rows="15" style="width: 100%" ></textarea>
		</div>
	</body>
</html>

<script>
	var UUID_CHARACTERISTIC	= "beb5483e-36e1-4688-b7f5-ea07361b26a8";
	var UUID_SERVICE 		= "4fafc201-1fb5-459e-8fcc-c5c9c331914b";

	var mConnection;

	log("start");

	$( function() 
	{
		$( ".widget input[type=submit], .widget a, .widget button" ).button();
		$( "button, input, a" ).click( function( event ) 
		{
			event.preventDefault();
		});
	});

	function log(msg) 
	{
		console.log("log: " + msg);
		var l = document.querySelector("#log");
		
		var prev = l.value;
		if (prev != null && prev != "")
			prev += "\n";

		prev += msg;

		l.value = prev;
	}

	function onCharChange(event) 
	{
		const value = new TextDecoder("utf-8").decode(event.target.value);
		log("received: " + value);
	}

	function ab2str(buf) 
	{
		return new TextDecoder("utf-8").decode(event.target.value);
	}

	function str2ab(str) 
	{
		var buf = new ArrayBuffer(str.length);
		var bufView = new Uint8Array(buf);
		for (var i = 0, strLen = str.length; i < strLen; i++) 
		{
			bufView[i] = str.charCodeAt(i);
		}

		return buf;
	}

	async function addCharacteristic(c)
	{
		await c.startNotifications();

		c.addEventListener("characteristicvaluechanged", onCharChange);

		if (c.hasOwnProperty("oncharacteristicvaluechanged"))
			c.oncharacteristicvaluechanged = onCharChange;

		switch (c.uuid)
		{
			case UUID_CHARACTERISTIC:
				log("got 'connection' " + c.uuid);
				mConnection = c;
				break;
		}

	}

	async function onClickTime() 
	{
		console.log("onClickTime");
		if (mConnection != null) 
		{
			var message = 
			{
				command: "set_time",
				time: new Date().getTime(),
			};

			var text = JSON.stringify(message);

			console.log("sending: " + text);

			var buf = str2ab(text);

			await mConnection.writeValueWithResponse(buf)
		}
	}

	document
		.querySelector("button")
		.addEventListener("click", async (event) => 
		{
			var options = 
			{
				acceptAllDevices: true,
				optionalServices: [UUID_SERVICE],
			};

			console.log(options);

			navigator.bluetooth
				.requestDevice(options)
				//({
				//acceptAllDevices: true,
				//Services: ["4fafc201-1fb5-459e-8fcc-c5c9c331914b"],
				//})
				.then((device) => 
				{
					log("connecting to " + device.name);
					return device.gatt.connect();
				})
				.then((server) => 
				{
					return server.getPrimaryService(UUID_SERVICE);
					// https://googlechrome.github.io/samples/web-bluetooth/get-characteristics.html?service=4fafc201-1fb5-459e-8fcc-c5c9c331914b
				})
				.then((service) => 
				{
					return service.getCharacteristics();
				})
				.then((characteristics) => 
				{
					characteristics.map(addCharacteristic);
				})
				.catch((error) => 
				{
					console.log(error);
					log(error.name + ": " + error.message);
				});
		});
</script>
